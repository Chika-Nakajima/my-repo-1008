name: Certificate Management

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  manage_certificates:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Find certificates
        id: find_certificates
        run: |
          find . -type f \( -name "*.pem" -o -name "*.crt" -o -name "*.cer" \) > certificates.txt || true
          cat certificates.txt  # 内容を出力
          if [ -s certificates.txt ]; then
            certificates=$(tr '\n' ',' < certificates.txt | sed 's/,$//')  # 最後のカンマを削除
            echo "certificates=$certificates" >> $GITHUB_ENV
          else
            echo "No certificates found."
            exit 1
          fi

      - name: Check certificates environment variable
        run: |
          echo "Certificates: ${{ env.certificates }}"

      - name: Update CSV
        run: |
          certificates="${{ env.certificates }}"
          csv_file="certificates.csv"
          PR_time="${{ github.event.pull_request.created_at }}"  # プルリクエストの作成時間を取得
          owner="${{ github.actor }}"

          # ヘッダーがすでに存在するかをチェック
          if [ ! -f $csv_file ]; then
            echo "File Path,File Name,Owner,PR_time,Timestamp" > $csv_file  # CSVヘッダーを追加
          fi

          # 既存のCSVを読み込む
          existing_entries=$(tail -n +2 $csv_file)  # ヘッダーを除いた部分を取得

          # 新しいエントリを追加するためのフラグ
          new_entries=()
          IFS=',' read -ra cert_array <<< "$certificates"
          for cert in "${cert_array[@]}"; do
            Timestamp=$(date +"%Y-%m-%d %H:%M:%S")  # 各行でアーティファクトの作成時間を取得
            entry="$cert,$(basename "$cert"),$owner,$PR_time,$Timestamp"
            # 新しいエントリが既存のものと異なる場合、追加する
            if ! echo "$existing_entries" | grep -qF "$entry"; then
              new_entries+=("$entry")
            fi
          done

          # 新しいエントリをCSVの最後に追記
          for new_entry in "${new_entries[@]}"; do
            echo "$new_entry" >> $csv_file
          done

      - name: Upload CSV as artifact
        uses: actions/upload-artifact@v3
        with:
          name: certificates
          path: certificates.csv

      - name: Notify Slack
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"新しい証明書が追加されました。必要事項を以下のリンクから記入してください。"}' ${{ secrets.SLACK_WEBHOOK_URL }}
