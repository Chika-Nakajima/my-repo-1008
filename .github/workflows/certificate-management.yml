name: Certificate Management

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  manage_certificates:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Find certificates
        id: find_certificates
        run: |
          # Find all certificate files
          find . -type f \( -name "*.pem" -o -name "*.crt" -o -name "*.cer" \) > certificates.txt || true
          echo "certificates=$(cat certificates.txt)" >> $GITHUB_ENV

      - name: Update CSV
        run: |
          certificates="${{ env.certificates }}"
          csv_file="certificates.csv"
          timestamp=$(date +"%Y-%m-%d %H:%M:%S")
          owner="${{ github.actor }}"  # プルリクエストのオーナー名を取得
          for cert in $certificates; do
            echo "$cert,$(basename $cert),$owner,$timestamp" >> $csv_file
          done
          # Append to the CSV file
          if [[ -f $csv_file ]]; then
            mv $csv_file $GITHUB_WORKSPACE/$csv_file
          else
            echo "File not found!"
          fi

      - name: Notify Slack
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"新しい証明書が追加されました。必要事項を以下のリンクから記入してください。"}' ${{ secrets.SLACK_WEBHOOK_URL }}
